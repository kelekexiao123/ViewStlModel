<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
  />
  <script type="text/javascript" src="asset/three.min.js"></script>
  <script type="text/javascript" src="asset/STLLoader.js"></script>
  <script type="text/javascript" src="asset/OrbitControls.js"></script>
  <script type="text/javascript" src="asset/weui/lib/jquery-2.1.4.js"></script>
  <script type="text/javascript" src="asset/weui/js/jquery-weui.min.js"></script>
  <link rel="stylesheet" href="asset/weui/lib/weui.min.css">
  <link rel="stylesheet" href="asset/weui/css/jquery-weui.min.css">
  <style>
    html,
    body {
      height: 100%;
    }

    .headline {
      height: 2rem;
      width: 100%;
      position: absolute;
      top: 0;
    }

    #webglDisplay {
      width: 100%;
      position: absolute;
      top: 2rem;
      bottom: 2rem;
      /* overflow: auto; */
    }

    .footline {
      height: 2rem;
      line-height: 2rem;
      width: 100%;
      position: absolute;
      bottom: 0;
    }
  </style>
</head>

<body>
  <div class="weui-flex headline">
    <div class="weui-flex__item">
      <div class="weui-cell">
        <div class="weui-cell__hd">
          <label class="weui-label">隐藏的器官</label>
        </div>
        <div class="weui-cell__bd">
          <input id="part_display_btn" class="weui-input" type="string" placeholder="还未选择任何器官">
        </div>
      </div>
    </div>
  </div>
  <div class="weui-flex" id="webglDisplay">
    <div class="weui-flex__item">
      <div id="container"></div>
    </div>
  </div>
  <div class="weui-flex footline">
    <div class="weui-flex__item">
      <div class="weui-footer">
        <p class="weui-footer__text">Copyright © 2014-2018 chenglong</p>
      </div>
    </div>
  </div>


  <script type="text/javascript">
    let width = $('#webglDisplay').width();
    let height = $('#webglDisplay').height();

    // 设置场景
    const scene = new THREE.Scene();
    const renderer = new THREE.WebGLRenderer();
    renderer.setClearColor("#eee");
    renderer.setSize(width, height);
    $('#container').append(renderer.domElement);

    // 设置相机
    // const camera = new THREE.PerspectiveCamera(120, window.innerWidth / window.innerHeight, 1, 1000);
    const camera = new THREE.OrthographicCamera(width / - 8, width / 8, height / 8, height / - 8, 1, 500);
    camera.position.set(0, 100, 0);
    camera.up.set(0, 0, 1);
    camera.lookAt(new THREE.Vector3(0, 0, 0));

    // 设置灯光
    const ambient = new THREE.AmbientLight("#999");
    scene.add(ambient); //设置全局光
    // const directionalLight = new THREE.DirectionalLight(0x333333);
    // directionalLight.position.set(-2, 9, 1).normalize();//设置平行光方向
    // scene.add(directionalLight);
    const pointlight_1 = new THREE.PointLight("#fff", 1, 3000);
    pointlight_1.position.set(0, 0, 2000);//设置点光源位置
    scene.add(pointlight_1);
    const pointlight_2 = new THREE.PointLight("#fff", 1, 2000);
    pointlight_2.position.set(-1000, 1000, 1000);
    scene.add(pointlight_2);
    const pointlight_3 = new THREE.PointLight("#fff", 1, 3000);
    pointlight_3.position.set(0, 0, -2000);
    scene.add(pointlight_3);
    const pointlight_4 = new THREE.PointLight("#fff", 1, 2000);
    pointlight_4.position.set(-2000, 0, 0);
    scene.add(pointlight_4);
    const pointlight_5 = new THREE.PointLight("#fff", 1, 2000);
    pointlight_5.position.set(0, -2000, 0);
    scene.add(pointlight_5);

    // 设置轨道控制
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 1;
    controls.enableZoom = true;
    controls.enablePan = true;

    // 设置辅助线
    // const axis = new THREE.AxisHelper(30);
    // scene.add(axis);

    render();


    $("#part_display_btn").select({
      title: "请选择需要隐藏的器官",
      multi: true,
      // split: "，",
      items: [],
      onClose: function changeDisplay(cb) {
        cb.config.items.forEach(function (item) {
          scene.getObjectByName(item.value).visible = true;
        })
        cb.data.origins.forEach(function (item) {
          scene.getObjectByName(item.value).visible = false;
        })
      }
    });

    $.getJSON("./config.json", function (data) {
      let menuData = [];
      menuData = data.menuData;
      $("#part_display_btn").select("update", {
        items: menuData
      });
      menuData.forEach(function (item) {
        modelLoader(scene, item.value, item.src, item.color);
      })
    });

    // 模型加载
    function modelLoader(scene, name, src, color) {
      const loader = new THREE.STLLoader();
      loader.load(src, function (geometry) {
        const material = new THREE.MeshLambertMaterial({ color: color });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.translateX(5);
        mesh.translateY(-50);
        mesh.translateZ(-20);
        mesh.name = name;
        mesh.scale.set(0.3, 0.3, 0.3);
        scene.add(mesh);
      });
    }
    // 轨道动画渲染
    function render() {
      requestAnimationFrame(render);
      controls.update();
      renderer.render(scene, camera);
    }

    function onDocumentMouseDown(e) {
      e.preventDefault();

      //将鼠标点击位置的屏幕坐标转成threejs中的标准坐标,具体解释见代码释义
      // mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      // mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      mouse.x = (event.touches[0].pageX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.touches[0].pageY / window.innerHeight) * 2 + 1;
      //新建一个三维单位向量 假设z方向就是0.5
      //根据照相机，把这个向量转换到视点坐标系
      var vector = new THREE.Vector3(mouse.x, mouse.y, 0.5).unproject(camera);

      //在视点坐标系中形成射线,射线的起点向量是照相机， 射线的方向向量是照相机到点击的点，这个向量应该归一标准化。
      var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

      //射线和模型求交，选中一系列直线
      var intersects = raycaster.intersectObjects(objects);
      console.log('imtersrcts=' + intersects)

      if (intersects.length > 0) {
        //选中第一个射线相交的物体
        SELECTED = intersects[0].object;
        var intersected = intersects[0].object;
        console.log(intersects[0].object)
      }
    }

    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    function pickupObjects(e) {
      //将鼠标点击位置的屏幕坐标转成threejs中的标准坐标
      mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      //从相机发射一条射线，经过鼠标点击位置
      raycaster.setFromCamera(mouse, camera);
      //计算射线相机到的对象，可能有多个对象，因此返回的是一个数组，按离相机远近排列
      let intersects = raycaster.intersectObjects(scene.children);
      for (var i = 0; i < intersects.length; i++) {
        intersects[i].object.material.color.set(0x00ff00);
      }
    }
  </script>

</body>

</html>